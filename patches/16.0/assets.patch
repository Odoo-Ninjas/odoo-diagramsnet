From 3af85887b131e3d88539ecd43a8c266c7d9842e9 Mon Sep 17 00:00:00 2001
From: Marc Wimmer <marc@itewimmer.de>
Date: Fri, 26 May 2023 00:23:25 +0200
Subject: [PATCH] for patch

---
 __manifest__.py                       |  27 +++---
 static/src/diagrams_net.js            |  98 ++++++++++++++++++++++
 static/{css => src}/diagrams_net.scss |   0
 static/src/diagrams_net.xml           |  12 +++
 static/src/js/diagrams_net.js         | 113 --------------------------
 static/xml/diagrams_net.xml           |   7 --
 6 files changed, 125 insertions(+), 132 deletions(-)
 create mode 100644 addons/diagrams_net/static/src/diagrams_net.js
 rename addons/diagrams_net/static/{css => src}/diagrams_net.scss (100%)
 create mode 100644 addons/diagrams_net/static/src/diagrams_net.xml
 delete mode 100644 addons/diagrams_net/static/src/js/diagrams_net.js
 delete mode 100644 addons/diagrams_net/static/xml/diagrams_net.xml

diff --git a/__manifest__.py b/__manifest__.py
index d40ff56e..fada74b7 100644
--- a/__manifest__.py
+++ b/__manifest__.py
@@ -1,12 +1,15 @@
-{   'application': False,
-    'author': 'Marc Wimmer (marc@itewimmer.de)',
-    'css': ['static/css/diagrams_net.scss'],
-    'data': ['views/assets.xml'],
-    'demo': [],
-    'depends': ['web'],
-    'external_dependencies': {'bin': [], 'python': []},
-    'name': 'diagrams_net',
-    'qweb': ['static/xml/diagrams_net.xml'],
-    'test': [],
-    'version': '13.0.1.0',
-    'web': True}
+{
+    "application": False,
+    "assets": {
+        "web.assets_backend": ["diagrams_net/static/src/**/*"],
+    },
+    "author": "Marc Wimmer (marc@itewimmer.de)",
+    "data": [],
+    "demo": [],
+    "depends": ["web"],
+    "external_dependencies": {"bin": [], "python": []},
+    "name": "diagrams_net",
+    "test": [],
+    "version": "16.0.1.0",
+    "web": True,
+}
diff --git a/static/src/diagrams_net.js b/static/src/diagrams_net.js
new file mode 100644
index 00000000..5e5ffdcc
--- /dev/null
+++ b/static/src/diagrams_net.js
@@ -0,0 +1,98 @@
+/** @odoo-module **/
+
+import { registry } from "@web/core/registry";
+import { Component, xml, useRef, onMounted, onWillUnmount, useState } from "@odoo/owl";
+import { TextField } from '@web/views/fields/text/text_field';
+import { standardFieldProps } from "@web/views/fields/standard_field_props";
+
+class Diagram extends Component {
+    get isReadonly() {
+        return true;
+    }
+    setup() {
+        this.rootRef = useRef("container");
+        this.state = useState({
+            url1: "",
+            url2: "",
+            image_data: "",
+        });
+        this.img = useRef("img1");
+        this.iframe1 = useRef("iframe1");
+        this.iframe2 = useRef("iframe2");
+        onMounted(this.onMounted);
+        onWillUnmount(this.onWillunmount);
+    }
+    onMounted() {
+        this.handler = window.addEventListener(
+            'message', (e) => this.message_received(e), false);
+        this.state.url1 = this.iframe_url();
+    }
+    onWillunmount() {
+        window.removeEventListener('message', this.handler);
+    }
+
+    iframe_url() {
+        return "https://embed.diagrams.net/?proto=json&client=0&ready=message&embed=1";
+    }
+    async message_received(evt) {
+        if (!evt.data) {
+            return;
+        }
+        var data = JSON.parse(evt.data);
+        if (data.event == 'init') {
+            if (!this.props.xml_content) {
+                this.iframe1.el.contentWindow.postMessage(JSON.stringify({
+                    action: "load",
+                    descriptor: {
+                        format: "csv",
+                        data: this.props.value,
+                    }
+                }), '*');
+            }
+            else {
+                if (this.iframe2 && this.iframe2.el.contentWindow) {
+                    this.iframe2.el.contentWindow.postMessage(JSON.stringify({
+                        action: "load",
+                        descriptor: {
+                            format: "xml",
+                            data: this.props.xml_content,
+                        }
+                    }), '*');
+                }
+            }
+        }
+        else if (data.event == 'load') {
+            if (!this.props.xml_content) {
+                this.props.xml_content = data.xml;
+                this.state.url2 = this.iframe_url();
+            }
+            else {
+                if (this.iframe2 && this.iframe2.el.contentWindow) {
+                    this.iframe2.el.contentWindow.postMessage(JSON.stringify({
+                        action: "export",
+                        format: "url",
+                    }), '*');
+                }
+            }
+        }
+        else if (data.event == 'export') {
+            this.state.url2 = '';
+            console.log(data.data);
+            this.state.image_data = data.data;
+        }
+    }
+}
+Diagram.template = "diagrams_net.diagrams_net_widget";
+Diagram.supportedTypes = ["text", "html"];
+Diagram.displayName = "Diagram";
+Diagram.defaultProps = {
+    xml_content: null,
+    image_data: "",
+};
+Diagram.props = {
+    ...standardFieldProps,
+    xml_content: { type: String, optional: true, },
+    image_data: { type: String, optional: true, },
+};
+
+registry.category("fields").add("diagrams_net", Diagram);
\ No newline at end of file
diff --git a/static/css/diagrams_net.scss b/static/src/diagrams_net.scss
similarity index 100%
rename from static/css/diagrams_net.scss
rename to static/src/diagrams_net.scss
diff --git a/static/src/diagrams_net.xml b/static/src/diagrams_net.xml
new file mode 100644
index 00000000..93f15eab
--- /dev/null
+++ b/static/src/diagrams_net.xml
@@ -0,0 +1,12 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<templates id="template" xml:space="preserve">
+	<t t-name="diagrams_net.diagrams_net_widget" owl="1">
+		<div class="diagrams-net-container" t-ref="container">
+			<img t-ref='img1' t-att-src="state.image_data"/>
+			<div style="display: none;">
+				<iframe t-ref="iframe1" t-if="state.url1" t-att-src="state.url1" style="height: 1800px;"/>
+				<iframe t-ref="iframe2" t-if="state.url2" t-att-src="state.url2"/>
+			</div>
+		</div>
+	</t>
+</templates>
\ No newline at end of file
diff --git a/static/src/js/diagrams_net.js b/static/src/js/diagrams_net.js
deleted file mode 100644
index 635b3429..00000000
--- a/static/src/js/diagrams_net.js
+++ /dev/null
@@ -1,113 +0,0 @@
-odoo.define("diagrams.net.widget", function(require) {
-
-    var AbstractField = require('web.AbstractField');
-    var core = require('web.core');
-    var QWeb = require('web.QWeb');
-    var field_registry = require('web.field_registry');
-
-    //override existing
-    var SourceCodeViewer = AbstractField.extend({
-        template: 'diagrams_net_widget',
-        init: function() {
-            this._super.apply(this, arguments);
-        },
-        destroy: function() {
-            this._super.apply(this, arguments);
-        },
-        start: function() {
-            res = this._super.apply(this, arguments);
-            var self = this;
-        },
-        destroy: function() {
-            debugger;
-            this._super.apply(this, arguments);
-            if (this.handler) {
-                document.body.removeEventListener(
-                    'message', this.message_received);
-            };
-
-        },
-        _render: function() {
-
-            var self = this;
-
-            self._super.apply(this, arguments);
-            window.addEventListener(
-                'message', self.message_received.bind(self), false);
-
-            if (!self.iframe1) {
-                self.iframe1 = self._makeiframe();
-            }
-            if (!self.iframe2) {
-                self.iframe2 = self._makeiframe();
-            }
-            self.img = self.$el.find("#img1");
-            self.xml_content = "";
-
-            self.iframe1.prop('src', self.iframe_url());
-
-        },
-        _makeiframe: function() {
-            var $res = $("<iframe/>").appendTo($("body"));
-            $res.hide();
-            return $res;
-        },
-        iframe_url: function() {
-            return "https://embed.diagrams.net/?proto=json&client=0&ready=message&embed=1";
-        },
-        message_received: function(evt) {
-            console.log(evt.data);
-            var self = this;
-
-            if (!evt.data) {
-                return;
-            }
-            var data = JSON.parse(evt.data);
-            if (data.event == 'init') {
-                if (!self.xml_content) {
-                    self.iframe1[0].contentWindow.postMessage(JSON.stringify({
-                        action: "load",
-                        descriptor: {
-                            format: "csv",
-                            data: self.value,
-                        }
-                    }), '*');
-                }
-                else {
-                    if (self.iframe2 && self.iframe2[0].contentWindow) {
-                        self.iframe2[0].contentWindow.postMessage(JSON.stringify({
-                            action: "load",
-                            descriptor: {
-                                format: "xml",
-                                data: this.xml_content,
-                            }
-                        }), '*');
-                    }
-                }
-            }
-            else if (data.event == 'load') {
-                if (!this.xml_content) {
-                    this.xml_content = data.xml;
-                    this.iframe1.css("height", "1800px");
-                    this.iframe1.remove();
-                    this.iframe2.prop("src", this.iframe_url());
-                }
-                else {
-                    if (this.iframe2 && this.iframe2[0].contentWindow) {
-                        this.iframe2[0].contentWindow.postMessage(JSON.stringify({
-                            action: "export",
-                            format: "url",
-                        }), '*');
-                    }
-                }
-            }
-            else if (data.event == 'export') {
-                this.iframe2.remove()
-                this.img.prop("src", data.data);
-            }
-        }
-    });
-    field_registry.add('diagrams_net', SourceCodeViewer); // as form widget
-    return SourceCodeViewer;
-
-});
\ No newline at end of file
diff --git a/static/xml/diagrams_net.xml b/static/xml/diagrams_net.xml
deleted file mode 100644
index f324fa09..00000000
--- a/static/xml/diagrams_net.xml
+++ /dev/null
@@ -1,7 +0,0 @@
-<templates>
-	<t t-name="diagrams_net_widget">
-		<div class="diagrams-net-container">
-			<img id="img1"/>
-		</div>
-	</t>
-</templates>
\ No newline at end of file
-- 
2.34.1